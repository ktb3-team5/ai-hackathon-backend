# ============================================
# ai-hackathon-backend CI/CD Pipeline
# EC2 ì§ì ‘ ë¹Œë“œ + RDS MySQL ì—°ê²°
# ============================================
#
# ğŸ“Œ í•„ìˆ˜ GitHub Secrets:
#   - EC2_HOST      : EC2 í¼ë¸”ë¦­ IP
#   - EC2_USER      : ubuntu
#   - EC2_SSH_KEY   : .pem íŒŒì¼ ë‚´ìš© ì „ì²´
#   - DB_URL        : jdbc:mysql://RDSì£¼ì†Œ:3306/DBì´ë¦„
#   - DB_USERNAME   : DB ìœ ì €ëª…
#   - DB_PASSWORD   : DB ë¹„ë°€ë²ˆí˜¸
#
# âš ï¸ ì„ íƒ Secrets (í•„ìš”ì‹œ ì¶”ê°€):
#   - JWT_SECRET    : JWT ì‹œí¬ë¦¿ í‚¤
# ============================================

name: Backend CI/CD

on:
  push:
    branches: [feat/cicd]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_URL,DB_USERNAME,DB_PASSWORD
          script: |
            set -e

            echo "===== 1. í”„ë¡œì íŠ¸ í´ë¡ /ì—…ë°ì´íŠ¸ ====="
            APP_DIR="/home/ubuntu/ai-hackathon-backend"
            REPO_URL="https://github.com/ktb3-team5/ai-hackathon-backend.git"
            BRANCH="feat/cicd"

            if [ ! -d "$APP_DIR" ]; then
              git clone -b $BRANCH $REPO_URL $APP_DIR
            fi

            cd $APP_DIR
            git fetch origin
            git checkout $BRANCH
            git reset --hard origin/$BRANCH

            echo "===== 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ ====="
            docker build -t backend:latest .

            echo "===== 3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ====="
            docker stop backend || true
            docker rm backend || true

            echo "===== 4. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ====="
            docker run -d \
              --name backend \
              --restart unless-stopped \
              -p 8080:8080 \
              -e SPRING_DATASOURCE_URL="$DB_URL" \
              -e SPRING_DATASOURCE_USERNAME="$DB_USERNAME" \
              -e SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
              backend:latest

            echo "===== 5. ì •ë¦¬ ====="
            docker image prune -af

            echo "===== ë°°í¬ ì™„ë£Œ! ====="
            docker ps | grep backend